name: infra_monolithic

trigger: none

pool: Remote_Agent

parameters:
- name: environment
  displayName: Select Environment
  type: string
  default: dev
  values:
    - dev
    - prod

variables:
- name: WORKDIR
  value: $(System.DefaultWorkingDirectory)/env

stages:
- stage: Terraform
  displayName: Terraform Init Validate Plan
  jobs:
  - job: terraform
    displayName: Terraform Job
    steps:

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: Terraform Init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(WORKDIR)/${{ parameters.environment }}'
        backendServiceArm: 'ANIKET_Shared_Connection'

    - task: TerraformTask@5
      displayName: Terraform Validate
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(WORKDIR)/${{ parameters.environment }}'

    - task: TerraformTask@5
      displayName: Terraform Plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(WORKDIR)/${{ parameters.environment }}'
        environmentServiceNameAzureRM: 'ANIKET_Shared_Connection'
